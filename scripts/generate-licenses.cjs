#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const root = path.resolve(__dirname, "..");
const lockPath = path.join(root, "package-lock.json");
const outPath = path.join(root, "THIRD_PARTY_LICENSES.txt");

function readJson(p){ return JSON.parse(fs.readFileSync(p,"utf8")); }
function normalizeLicense(val){
  if(!val) return "UNKNOWN";
  if(typeof val==="string") return val.trim();
  if(Array.isArray(val)) return val.map(normalizeLicense).join(" OR ");
  if(typeof val==="object" && val.type) return String(val.type).trim();
  return "UNKNOWN";
}

(function main(){
  if(!fs.existsSync(lockPath)) { console.error("package-lock.json not found"); process.exit(1); }
  const lock = readJson(lockPath);
  const pkgs = lock.packages;
  if(!pkgs) { console.error("lockfile missing packages metadata"); process.exit(1); }

  const entries = [];
  for(const [p, meta] of Object.entries(pkgs)){
    if(!p || p==="" || !p.startsWith("node_modules/")) continue;
    if(meta.link) continue;
    const name = p.replace(/^node_modules\//,"");
    const version = meta.version || "UNKNOWN";
    const license = normalizeLicense(meta.license);
    entries.push({name, version, license, resolved: meta.resolved||"", integrity: meta.integrity||""});
  }
  entries.sort((a,b)=>a.name.localeCompare(b.name));

  const header = [
    "ShutterQueue â€” Third-Party Licenses",
    "Generated by scripts/generate-licenses.cjs",
    `Generated at: ${new Date().toISOString()}`,
    "",
    "NOTE: This file is generated from package-lock.json metadata. If any entries show UNKNOWN, audit those dependencies manually.",
    "",
  ].join("\n");

  const sep="\n\n"+"-".repeat(60)+"\n\n";
  const body = entries.map(e=>{
    const lines=[`${e.name}@${e.version}`, `License: ${e.license}`];
    if(e.resolved) lines.push(`Resolved: ${e.resolved}`);
    if(e.integrity) lines.push(`Integrity: ${e.integrity}`);
    return lines.join("\n");
  }).join(sep);

  fs.writeFileSync(outPath, header + body + "\n", "utf8");
  console.log(`Wrote ${outPath} with ${entries.length} entries.`);
})();

